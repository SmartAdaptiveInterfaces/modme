<head>
{% for file in cssList %}
    <link href = "/static/{{ file }}" rel="stylesheet" type="text/css">
{% endfor %}
</head>

<body>
<!-- <script src="/static/d3/d3.v3.min.js"></script>
<script src="/static/d3/d3.chart.min.js"></script>
<script src="/static/ModME/MAT-B_charts.js"></script> -->
{% for file in fileList %}
    <script src="/static/{{ file }}"></script>
{% endfor %}
<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%">
<div id="row1">
    <div id="slot1" style="display:inline-block; position: relative;"></div>
    <div id="slot2" style="display:inline-block; position: absolute;"></div>
</div>
<div id="row2">
    <div id="slot3" style="display:inline-block; position: relative;"></div>
    <div id="slot4" style="display:inline-block; position: absolute;"></div>
</div>
</div>

<script>
    document.addEventListener("contextmenu", function(event){
        if(event.button == 2) {
            event.preventDefault();
        }
    }, false);

    var False = false;
    var True = true;

    var data = [];

    var body = d3.select("body");
    var row1 = d3.select("#row1");
    var row2 = d3.select("#row2");

    d3.select("body")
        .style("margin", "0px")
        .style("background-color", "#e8e8e8");

    var scale = d3.scale.linear();
    if(!{{ parameters.task2GUI }} && !{{ parameters.task3GUI }} && !{{ parameters.task4GUI }}) {
    
        if((window.innerWidth)/(window.innerHeight-5)<=1){
            scale.range([0,window.innerWidth]);
            scale.domain([0,1]);
        }
        else{
            scale.range([0,window.innerHeight-5]);
            scale.domain([0,1]);
        }

        document.getElementById("slot1").style.width = scale(1);
        document.getElementById("slot1").style.height = scale(1);

        document.getElementById("slot2").style.width = 0;
        document.getElementById("slot2").style.height = 0;

        document.getElementById("slot3").style.width = 0;
        document.getElementById("slot3").style.height = 0;

        document.getElementById("slot4").style.width = 0;
        document.getElementById("slot4").style.height = 0;

        row1.style("width", scale(1));
        row1.style("height", scale(1));
        row2.style("width", 0);
        row2.style("height", 0);
    
    }else if(!{{ parameters.task1GUI }} && !{{ parameters.task3GUI }} && !{{ parameters.task4GUI }}) {
        
        if((window.innerWidth)/(window.innerHeight-5)<=2){
            scale.range([0,window.innerWidth]);
            scale.domain([0,2]);
        }
        else{
            scale.range([0,window.innerHeight-5]);
            scale.domain([0,1]);
        }

        document.getElementById("slot1").style.width = 0;
        document.getElementById("slot1").style.height = 0;

        document.getElementById("slot2").style.width = scale(2);
        document.getElementById("slot2").style.height = scale(1);

        document.getElementById("slot3").style.width = 0;
        document.getElementById("slot3").style.height = 0;

        document.getElementById("slot4").style.width = 0;
        document.getElementById("slot4").style.height = 0;

        row1.style("width", scale(2));
        row1.style("height", scale(1));
        row2.style("width", 0);
        row2.style("height", 0);

    }else if(!{{ parameters.task1GUI }} && !{{ parameters.task2GUI }} && !{{ parameters.task4GUI }}) {
    
        if((window.innerWidth)/(window.innerHeight-5)<=1){
            scale.range([0,window.innerWidth]);
            scale.domain([0,1]);
        }
        else{
            scale.range([0,window.innerHeight-5]);
            scale.domain([0,1]);
        }

        document.getElementById("slot1").style.width = 0;
        document.getElementById("slot1").style.height = 0;

        document.getElementById("slot2").style.width = 0;
        document.getElementById("slot2").style.height = 0;

        document.getElementById("slot3").style.width = scale(1);
        document.getElementById("slot3").style.height = scale(1);

        document.getElementById("slot4").style.width = 0;
        document.getElementById("slot4").style.height = 0;

        row1.style("width", 0);
        row1.style("height", 0);
        row2.style("width", scale(1));
        row2.style("height", scale(1));

    }else if(!{{ parameters.task1GUI }} && !{{ parameters.task2GUI }} && !{{ parameters.task3GUI }}) {

        if((window.innerWidth)/(window.innerHeight-5)<=2){
            scale.range([0,window.innerWidth]);
            scale.domain([0,2]);
        }
        else{
            scale.range([0,window.innerHeight-5]);
            scale.domain([0,1]);
        }

        document.getElementById("slot1").style.width = 0;
        document.getElementById("slot1").style.height = 0;

        document.getElementById("slot2").style.width = 0;
        document.getElementById("slot2").style.height = 0;

        document.getElementById("slot3").style.width = 0;
        document.getElementById("slot3").style.height = 0;

        document.getElementById("slot4").style.width = scale(2);
        document.getElementById("slot4").style.height = scale(1);

        row1.style("width", 0);
        row1.style("height", 0);
        row2.style("width", scale(2));
        row2.style("height", scale(1));

    }else if(!{{ parameters.task3GUI }} && !{{ parameters.task4GUI }}) {
    
        if((window.innerWidth)/(window.innerHeight-5)<=3){
            scale.range([0,window.innerWidth]);
            scale.domain([0,3]);
        }
        else{
            scale.range([0,window.innerHeight-5]);
            scale.domain([0,1]);
        }

        document.getElementById("slot1").style.width = scale(1);
        document.getElementById("slot1").style.height = scale(1);

        document.getElementById("slot2").style.width = scale(2);
        document.getElementById("slot2").style.height = scale(1);

        document.getElementById("slot3").style.width = 0;
        document.getElementById("slot3").style.height = 0;

        document.getElementById("slot4").style.width = 0;
        document.getElementById("slot4").style.height = 0;

        row1.style("width", scale(3));
        row1.style("height", scale(1));
        row2.style("width", 0);
        row2.style("height", 0);

    }else if(!{{ parameters.task1GUI }} && !{{ parameters.task2GUI }}) {
    
        if((window.innerWidth)/(window.innerHeight-5)<=3){
            scale.range([0,window.innerWidth]);
            scale.domain([0,3]);
        }
        else{
            scale.range([0,window.innerHeight-5]);
            scale.domain([0,1]);
        }
        document.getElementById("slot1").style.width = 0;
        document.getElementById("slot1").style.height = 0;

        document.getElementById("slot2").style.width = 0;
        document.getElementById("slot2").style.height = 0;

        document.getElementById("slot3").style.width = scale(1);
        document.getElementById("slot3").style.height = scale(1);

        document.getElementById("slot4").style.width = scale(2);
        document.getElementById("slot4").style.height = scale(1);

        row1.style("width", 0);
        row1.style("height", 0);
        row2.style("width", scale(3));
        row2.style("height", scale(1));


    }else if(!{{ parameters.task2GUI }} && !{{ parameters.task4GUI }}) {
    
        if((window.innerWidth)/(window.innerHeight-5)<=.5){
            scale.range([0,window.innerWidth]);
            scale.domain([0,1]);
        }
        else{
            scale.range([0,window.innerHeight-5]);
            scale.domain([0,2]);
        }

        document.getElementById("slot1").style.width = scale(1);
        document.getElementById("slot1").style.height = scale(1);

        document.getElementById("slot2").style.width = 0;
        document.getElementById("slot2").style.height = 0;

        document.getElementById("slot3").style.width = scale(1);
        document.getElementById("slot3").style.height = scale(1);

        document.getElementById("slot4").style.width = 0;
        document.getElementById("slot4").style.height = 0;

        row1.style("width", scale(1));
        row1.style("height", scale(1));
        row2.style("width", scale(1));
        row2.style("height", scale(1));

    }else if(!{{ parameters.task1GUI }} && !{{ parameters.task3GUI }}) {
        
        if((window.innerWidth)/(window.innerHeight-5)<=1){
            scale.range([0,window.innerWidth]);
            scale.domain([0,2]);
        }
        else{
            scale.range([0,window.innerHeight-5]);
            scale.domain([0,2]);
        }

        document.getElementById("slot1").style.width = 0;
        document.getElementById("slot1").style.height = 0;

        document.getElementById("slot2").style.width = scale(2);
        document.getElementById("slot2").style.height = scale(1);

        document.getElementById("slot3").style.width = 0;
        document.getElementById("slot3").style.height = 0;

        document.getElementById("slot4").style.width = scale(2);
        document.getElementById("slot4").style.height = scale(1);

        row1.style("width", scale(2));
        row1.style("height", scale(1));
        row2.style("width", scale(2));
        row2.style("height", scale(1));

    }else {
        if((window.innerWidth)/(window.innerHeight-5)<=1.5){
            scale.range([0,window.innerWidth]);
            scale.domain([0,3]);
        }
        else{
            scale.range([0,window.innerHeight-5]);
            scale.domain([0,2]);
        }

        document.getElementById("slot1").style.width = scale(1);
        document.getElementById("slot1").style.height = scale(1);

        document.getElementById("slot2").style.width = scale(2);
        document.getElementById("slot2").style.height = scale(1);

        document.getElementById("slot3").style.width = scale(1);
        document.getElementById("slot3").style.height = scale(1);

        document.getElementById("slot4").style.width = scale(2);
        document.getElementById("slot4").style.height = scale(1);

        row1.style("width", scale(3));
        row1.style("height", scale(1));
        row2.style("width", scale(3));
        row2.style("height", scale(1));

    }

    var startTime = (new Date()).getTime();

    data.push({
        time: startTime,
        duration: {{ parameters.experimentDuration }},
        participantAlias:"{{ participantAlias }}",
        sessionName: "{{ sessionName }}",
        condition: "{{ parameters.Name }}",
        table:"Meta"
    });
    
    var setup = {
            {{ taskNames.0 }}: {
                data: JSON.parse(("{{ parameters.task1Data }}").replace(/&(l|g|quo)t;/g,
                    function(a,b){
                        return {
                            l :'<',
                            g :'>',
                            quo:'"'
                        }[b];
                    })),
                container: "slot1"
            },
            {{ taskNames.1 }}: {
                data: JSON.parse(("{{ parameters.task2Data }}").replace(/&(l|g|quo)t;/g,
                    function(a,b){
                        return {
                            l :'<',
                            g :'>',
                            quo:'"'
                        }[b];
                    })),
                container: "slot2"
            },
            {{ taskNames.2 }}: {
                data: JSON.parse(("{{ parameters.task3Data }}").replace(/&(l|g|quo)t;/g,
                    function(a,b){
                        return {
                            l :'<',
                            g :'>',
                            quo:'"'
                        }[b];
                    })),
                container: "slot3"
            },
            {{ taskNames.3 }}: {
                data: JSON.parse(("{{ parameters.task4Data }}").replace(/&(l|g|quo)t;/g,
                    function(a,b){
                        return {
                            l :'<',
                            g :'>',
                            quo:'"'
                        }[b];
                    })),
                container: "slot4"
            },
    }
    keyboard = [];
    d3.select(window).on("keydown",function(){
        d3.event.preventDefault();
        var keyCode = d3.event.keyCode;
        var time = (new Date()).getTime();
        keyboard.forEach(function(d){d(d3.event, time)})
    });
    {% for thing in parameters.surveys.all %}
        console.log("{{ thing.fileName }}")
    {% endfor %}
    console.log("{{ parameters.surveys.all.0.fileName }}")

    function complete(){
        document.getElementById("data_field").value=JSON.stringify(data);
        document.getElementById("complete").click();
    }
    setTimeout(complete, (60000*{{ parameters.experimentDuration }}));

    
</script>
{% for task in taskList %}
    <script src="/static/{{ task.fileName }}"></script>
{% endfor %}

<form action="{% url 'ModME:done' %}" method="post" style="display:none">
{% csrf_token %}
<input type="hidden" name="data" id="data_field"/>
<input type="hidden" name="id" id="id_field" value="{{ parameters.id }}"/>
<input type="submit" value="Complete" id="complete" style="visibility:hidden"/>
</form>
